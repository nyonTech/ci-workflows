name: Backend CI/CD Pipeline

on:
  workflow_call:
    inputs:
      app_name:
        required: true
        type: string
      node_version:
        type: string
        default: '18'
      package_manager:
        type: string
        default: 'npm'
      staging_branch:
        type: string
        default: 'develop'
      production_branch:
        type: string
        default: 'main'
      backend_port_staging:
        type: string
        default: '3001'
      backend_port_production:
        type: string
        default: '3000'
      health_check_path:
        type: string
        default: '/health'
      custom_deploy_script:
        type: string
        default: ''
      enable_slack_notifications:
        type: boolean
        default: true
      slack_channel:
        type: string
        default: '#deployments'
    secrets:
      STAGING_EC2_HOST: { required: false }
      PROD_EC2_HOST: { required: false }
      EC2_USERNAME: { required: false }
      STAGING_EC2_KEY: { required: false }
      PROD_EC2_KEY: { required: false }
      REPO_URL: { required: false }
      SLACK_WEBHOOK_URL: { required: false }
      STAGING_URL: { required: false }
      PROD_URL: { required: false }

env:
  APP_NAME: ${{ inputs.app_name }}
  NODE_VERSION: ${{ inputs.node_version }}
  PACKAGE_MANAGER: ${{ inputs.package_manager }}

jobs:
  deploy-staging-backend:
    if: github.ref == format('refs/heads/{0}', inputs.staging_branch)
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.STAGING_EC2_KEY }}
          timeout: 300s
          envs: APP_NAME,NODE_VERSION,PACKAGE_MANAGER
          script: |
            set -e
            cd /home/ubuntu/${{ env.APP_NAME }}
            sudo cp -r . ../app-backup-$(date +%Y%m%d-%H%M%S)
            git fetch origin
            git checkout ${{ inputs.staging_branch }}
            git pull origin ${{ inputs.staging_branch }}
            if [ "$PACKAGE_MANAGER" = "yarn" ]; then yarn install --production --frozen-lockfile
            elif [ "$PACKAGE_MANAGER" = "pnpm" ]; then pnpm install --prod --frozen-lockfile
            else
              rm -rf node_modules
              npm ci --production --ignore-scripts
              npm rebuild
            fi
            if [ -n "${{ inputs.custom_deploy_script }}" ]; then bash ${{ inputs.custom_deploy_script }} staging; fi
            if pm2 describe $APP_NAME-staging > /dev/null 2>&1; then pm2 reload $APP_NAME-staging --wait-ready
            else pm2 start ecosystem.config.js --env staging; fi
            sleep 10
            curl -f http://localhost:${{ inputs.backend_port_staging }}${{ inputs.health_check_path }}

  deploy-production-backend:
    if: github.ref == format('refs/heads/{0}', inputs.production_branch)
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.PROD_EC2_KEY }}
          timeout: 600s
          envs: APP_NAME,NODE_VERSION,PACKAGE_MANAGER
          script: |
            set -e

            echo "=== DEPLOY STARTED ==="
            echo "App: $APP_NAME"
            echo "Branch: ${{ inputs.production_branch }}"
            echo "Timestamp: $(date)"
            DEPLOY_START_TIME=$(date +%s)

            cd /home/ubuntu/

            # Clone or update repo
            if [ ! -d "${{ env.APP_NAME }}" ]; then
              echo "Directory not found. Cloning repo..."
              sudo mkdir -p "${{ env.APP_NAME }}"
              cd "${{ env.APP_NAME }}"
              git clone -b ${{ inputs.production_branch }} ${{ secrets.REPO_URL }} .
              echo "Repo cloned successfully."
            else
              cd "${{ env.APP_NAME }}"
              echo "Repo exists. Fetching latest changes..."
              sudo git fetch origin ${{ inputs.production_branch }}
              git checkout ${{ inputs.production_branch }}
              sudo git pull origin ${{ inputs.production_branch }}
              echo "Repo updated successfully."
            fi

            # Stop the app before installing dependencies
            if pm2 list | grep -q -- "$APP_NAME-production"; then
              echo "Stopping existing PM2 process..."
              pm2 delete "$APP_NAME-production"
              echo "PM2 process stopped."
            else
              echo "No existing PM2 process found."
            fi

            # Install dependencies
            echo "Installing dependencies using $PACKAGE_MANAGER..."
            if [ "$PACKAGE_MANAGER" = "yarn" ]; then
              yarn install --production --frozen-lockfile
            elif [ "$PACKAGE_MANAGER" = "pnpm" ]; then
              pnpm install --prod --frozen-lockfile
            else
              rm -rf node_modules
              npm ci --production --ignore-scripts
              npm rebuild
            fi
            echo "Dependencies installed successfully."

            # Run custom deploy script if provided
            if [ -n "${{ inputs.custom_deploy_script }}" ]; then
              echo "Running custom deploy script..."
              bash ${{ inputs.custom_deploy_script }} production
              echo "Custom deploy script completed."
            else
              echo "No custom deploy script provided."
            fi

            # Start the app using ecosystem config
            echo "Starting PM2 process from ecosystem config..."
            pm2 start ecosystem.config.js --only "$APP_NAME-production"
            pm2 save
            echo "PM2 process started."

            # Wait for app to boot
            echo "Waiting 10 seconds for app to start..."
            sleep 10

            # Health check with retries
            echo "Performing health check with retries..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
              
              if curl -f -m 10 http://localhost:${{ inputs.backend_port_production }}${{ inputs.health_check_path }}; then
                echo "✅ Health check passed!"
                HEALTH_CHECK_PASSED=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  WAIT_TIME=$((5 * RETRY_COUNT))
                  echo "Failed. Retrying in ${WAIT_TIME}s..."
                  sleep $WAIT_TIME
                fi
              fi
            done

            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "❌ Health check failed after $MAX_RETRIES attempts!"
              echo "Initiating rollback..."
              
              pm2 delete "$APP_NAME-production" || true
              
              # Find the most recent backup
              LATEST_BACKUP=$(ls -dt /home/ubuntu/app-backup-* 2>/dev/null | head -n 1)
              
              if [ -n "$LATEST_BACKUP" ]; then
                echo "Rolling back to: $LATEST_BACKUP"
                cd /home/ubuntu
                rm -rf "$APP_NAME"
                cp -r "$LATEST_BACKUP" "$APP_NAME"
                cd "$APP_NAME"
                pm2 start ecosystem.config.js --only "$APP_NAME-production"
                pm2 save
                echo "✅ Rollback completed. Previous version restored."
              else
                echo "⚠️ No backup found! Manual intervention required."
              fi
              
              exit 1
            fi

            # Clean up old backups (keep last 5)
            echo "Cleaning up old backups..."
            cd /home/ubuntu
            ls -dt app-backup-* 2>/dev/null | tail -n +6 | xargs -r rm -rf

            # Deployment metrics
            DEPLOY_END_TIME=$(date +%s)
            DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
            GIT_COMMIT=$(git rev-parse --short HEAD)

            echo ""
            echo "╔════════════════════════════════════════╗"
            echo "║       DEPLOYMENT SUCCESSFUL            ║"
            echo "╠════════════════════════════════════════╣"
            echo "║ Duration:    ${DEPLOY_DURATION}s"
            echo "║ Commit:      $GIT_COMMIT"
            echo "║ Deployed by: ${{ github.actor }}"
            echo "║ Timestamp:   $(date)"
            echo "╚════════════════════════════════════════╝"
